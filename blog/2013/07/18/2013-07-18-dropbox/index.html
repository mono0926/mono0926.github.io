<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:400,700" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/github.min.css">
<link rel="stylesheet" href="/css/normalize.css">
<link rel="stylesheet" href="/css/skeleton.css">
<link rel="stylesheet" href="/css/custom.css">
<link rel="alternate" href="/index.xml" type="application/rss+xml" title="mono-log">
<title>iOSからDropbox新APIのDatastore APIを使ってみる - mono-log</title>
</head>
<body>

<div class="container">

	<header role="banner">
		<div class="header-logo">
			<a href="/"><img src="/images/love.png" width="60" height="60"></a>
		</div>
		
	</header>


	<main role="main">
		<article itemscope itemtype="http://schema.org/BlogPosting">
			<h1 class="entry-title" itemprop="headline">iOSからDropbox新APIのDatastore APIを使ってみる</h1>
			<span class="entry-meta"><time itemprop="datePublished" datetime="2013-07-18">July 18, 2013</time></span>
			<section itemprop="entry-text">
				

<h3 id="サンプルとドキュメント:a122102cf8bfc794929bb1df9254c887">サンプルとドキュメント</h3>

<ul>
<li>サンプル

<ul>
<li><a href="https://www.dropbox.com/developers/datastore/sdks/ios">Datastore API SDKs</a>からSDKダウンロードすると同梱されてる</li>
</ul></li>
<li>ドキュメント

<ul>
<li><a href="https://www.dropbox.com/developers/datastore/docs/ios">Datastore API for iOS Documentation</a></li>
</ul></li>
<li>チュートリアル

<ul>
<li><a href="https://www.dropbox.com/developers/datastore/tutorial/ios">Using the Datastore API on iOS</a></li>
</ul></li>
</ul>

<h3 id="サンプル起動:a122102cf8bfc794929bb1df9254c887">サンプル起動</h3>

<h4 id="datastore-examplesのサンプル:a122102cf8bfc794929bb1df9254c887">Datastore Examplesのサンプル</h4>

<p>起動後Dropboxの認証を求められて、認証が通るとTODOアプリが開く。
アイテムの追加とDone状態の切り替えのシンプルなサンプル。
リンクしたDropboxには特に新しいファイルなど生成されていない様子。</p>

<p>2台目にインストールして認証するとちゃんと1台目で追加したタスクが出てきて、当たり前だけどなんか関心（´-ω-｀）</p>

<!-- more -->

<p><img src="/images/post/todo.png" alt="todo" />
</p>

<h3 id="チュートリアル-https-www-dropbox-com-developers-datastore-tutorial-ios-を読み解く:a122102cf8bfc794929bb1df9254c887"><a href="https://www.dropbox.com/developers/datastore/tutorial/ios">チュートリアル</a>を読み解く</h3>

<ul>
<li>複数端末間でのコンフリクトは自動的に解消される(挙動を変えるにはフィールドごとにルールを設定出来る)

<ul>
<li>DBResolutionRemote：リモート優先(デフォルト)</li>
<li>DBResolutionLocal：ローカル優先</li>
<li>DBResolutionMax：大きい値優先</li>
<li>DBResolutionMin：小さい値優先</li>
<li>DBResolutionSum：適当に足し引きされる</li>
</ul></li>
<li>RDBと違ってスキーマを持たない

<ul>
<li>KVSに近い感じ。keyと適当な型のvalueのペア。</li>
</ul></li>
<li>Account manager

<ul>
<li>認証用</li>
</ul></li>
<li>Datasotores and tables

<ul>
<li>データベース本体</li>
<li>オフライン動作可</li>
<li>オンライン同期するにはsyncを明示的に呼ぶ</li>
<li>トランザクション</li>
</ul></li>
</ul>

<h3 id="実装:a122102cf8bfc794929bb1df9254c887">実装</h3>

<h4 id="アカウント認証:a122102cf8bfc794929bb1df9254c887">アカウント認証</h4>

<p>他のDropbox APIと同じような定型的な感じ。</p>

<pre><code class="language-objective-c">// AppDelegate
- (BOOL)application:(UIApplication *)app didFinishLaunchingWithOptions:(NSDictionary *)opts {
    DBAccountManager* accountMgr =
        [[DBAccountManager alloc] initWithAppKey:@&quot;APP_KEY&quot; secret:@&quot;APP_SECRET&quot;];
    [DBAccountManager setSharedManager:accountMgr];
}
</code></pre>

<pre><code class="language-objective-c">// Some view controller
- (IBAction)didPressLink {
    DBAccount *account = [[DBAccountManager sharedManager] linkedAccount];
    if (account) {
        NSLog(@&quot;App already linked&quot;);
    } else {
        [[DBAccountManager sharedManager] linkFromController:self];
    }
}
</code></pre>

<pre><code class="language-objective-c">// AppDelegate
- (BOOL)application:(UIApplication *)app openURL:(NSURL *)url
    sourceApplication:(NSString *)source annotation:(id)annotation {
    DBAccount *account = [[DBAccountManager sharedManager] handleOpenURL:url];
    if (account) {
        NSLog(@&quot;App linked successfully!&quot;);
        return YES;
    }
    return NO;
}
</code></pre>

<h4 id="テーブル作成-取得:a122102cf8bfc794929bb1df9254c887">テーブル作成・取得</h4>

<p>多分無かったら作る、あったら取得みたいな感じ。</p>

<pre><code class="language-objective-c">DBDatastore *store = [DBDatastore openDefaultStoreForAccount:account error:nil];
DBTable *tasksTbl = [store getTable:@&quot;tasks&quot;];
</code></pre>

<h4 id="レコード操作:a122102cf8bfc794929bb1df9254c887">レコード操作</h4>

<p>同じテーブルに対して、異なるキー・バリューの型突っ込めるらしい。</p>

<pre><code class="language-objective-c">DBRecord *firstTask = [tasksTbl insert:@{ @&quot;taskname&quot;: @&quot;Buy milk&quot;, @&quot;completed&quot;: @NO }];
[store sync:nil];
</code></pre>

<h4 id="テーブルのレコードの増減監視:a122102cf8bfc794929bb1df9254c887">テーブルのレコードの増減監視</h4>

<pre><code class="language-objective-c">[store addObserver:self block:^() {
    if (store.status &amp; DBDatastoreIncoming) {
        NSDictionary *changed = [slf.store sync:nil];
        // 何が変わったか調べて処理
    }
}];
</code></pre>

<h4 id="バリューの型:a122102cf8bfc794929bb1df9254c887">バリューの型</h4>

<ul>
<li>String</li>
<li>Boolean</li>
<li>Integer</li>
<li>Floating</li>
<li>Date</li>
<li>Bytes

<ul>
<li>最大100KB</li>
<li>より大きいサイズはSync APIやfilepathベースで扱うようにとのこと</li>
</ul></li>
<li>List</li>
</ul>

<h4 id="ストレージの容量:a122102cf8bfc794929bb1df9254c887">ストレージの容量</h4>

<p>冒頭に</p>

<blockquote>
<p>リンクしたDropboxには特に新しいファイルなど生成されていない様子</p>
</blockquote>

<p>と書いたけど、5MBはユーザーストレージを使わずにアプリケーションごとに割り当てられていて、それを超えるとユーザーストレージ領域を使っていくという感じ。それさえ食い尽くすとリミット。
ユーザーのストレージ汚さないようにしたい場合は5MB制限に気をつける。</p>

<h3 id="弄ってみた印象:a122102cf8bfc794929bb1df9254c887">弄ってみた印象</h3>

<p>ネットワーク状態に応じての同期とか意識しなくて良いし、本来サーバー実装するべきところをSDKに任せられて良い一方、ローカルでのクエリが少し冗長な感じ。<br />
サンプルは1テーブルなのに増減監視でごちゃごちゃ処理してて複数テーブルとかその関連とか考え出すと素のままじゃ使うの厳しそう。
Core Data使えばNSFetchedResultsControllerでコレクション監視がかなり簡潔に書けるところを自前実装じなくちゃいけなくて、自前アプリに導入するならそこらへんうまくフレームワーク化しないと快適に使えない感じ(そんな感じのライブラリ作っていくのも面白そうだけど)。</p>

<p>Apple製品に閉じられるなら、Core Data + iCloudの方がやはり良いなあという感じ（´-ω-｀）
参考：<a href="http://d.hatena.ne.jp/glass-_-onion/20120728/1343471940">iCloud プログラミング入門</a></p>

			</section>
		</article>
	</main>


	<footer role="contentinfo">
		<div class="hr"></div>
		<div class="footer-link">
			<a href="mailto:mono0926@gmail.com" target="_blank">Email</a></span>
			<a href="https://twitter.com/_mono" target="_blank">Twitter</a></span>
			<a href="https://www.facebook.com/mono0926" target="_blank">Facebook</a></span>
			<a href="https://github.com/mono0926" target="_blank">GitHub</a></span>
		</div>
		<div class="copyright">Copyright &copy; Masayuki Ono All right reserved.</div>
	</footer>

</div>

<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-11434295-7', 'auto');
	ga('send', 'pageview');
</script>

<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

</body>
</html>